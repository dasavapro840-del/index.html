<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>–ö–∞—Ä—Ç–∞ —Å–æ–∫—Ä–æ–≤–∏—â</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Marck+Script&display=swap');

:root{
  --ink:#2a1c12;
  --paper:#efe0bf;
  --paper2:#e3d0a8;
  --edge:#3b2a1a;
  --floor:#f7edd3;

  /* –º–∞—Å—à—Ç–∞–± –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (—Å—Ç–∞–≤–∏—Ç—Å—è JS) */
  --uiScale: 1;
}
*{ box-sizing:border-box; }

body{
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:flex-start;        /* –≤–∞–∂–Ω–æ: —Å–≤–µ—Ä—Ö—É, —á—Ç–æ–±—ã –Ω–µ "—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–ª–æ—Å—å" —Å—Ç—Ä–∞–Ω–Ω–æ */
  overflow-x:auto;               /* –≤–º–µ—Å—Ç–æ —Å–∂–∞—Ç–∏—è ‚Äî –ø—É—Å—Ç—å –º–æ–∂–Ω–æ —Å–∫—Ä–æ–ª–ª–∏—Ç—å */
  background:
    radial-gradient(900px 500px at 30% 20%, rgba(255,255,255,.25), transparent 60%),
    radial-gradient(700px 420px at 70% 75%, rgba(0,0,0,.08), transparent 60%),
    #cfc2a2;
  font-family:'Marck Script', cursive;
  color:var(--ink);
  padding: 14px 0;
}

/* ===== –†–í–ê–ù–û–ï –ü–û–õ–û–¢–ù–û ===== */
.sheet{
  width:920px;                 /* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è "–¥–µ—Å–∫—Ç–æ–ø–Ω–∞—è" —à–∏—Ä–∏–Ω–∞ */
  max-width:none;              /* –ù–ï —Å–∂–∏–º–∞–µ–º –ø–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω */
  padding:38px;
  position:relative;
  background:
    radial-gradient(120px 90px at 20% 30%, rgba(0,0,0,.07), transparent 70%),
    radial-gradient(180px 120px at 70% 60%, rgba(0,0,0,.08), transparent 70%),
    radial-gradient(90px 70px at 80% 25%, rgba(0,0,0,.06), transparent 70%),
    linear-gradient(135deg, var(--paper), var(--paper2));
  border:none;
  border-radius:0;
  overflow:visible;
  box-shadow: 0 22px 60px rgba(0,0,0,.35), inset 0 0 70px rgba(0,0,0,.14);
  clip-path: polygon(
    2% 7%, 6% 3%, 12% 4%, 18% 2%, 26% 4%, 34% 2%, 42% 4%, 50% 2%, 58% 4%, 66% 2%, 74% 4%, 82% 2%, 90% 4%, 95% 3%, 98% 8%,
    98% 14%, 97% 20%, 99% 27%, 97% 34%, 99% 41%, 97% 49%, 99% 57%, 97% 65%, 99% 73%, 97% 81%, 98% 88%, 96% 94%,
    92% 97%, 86% 98%, 80% 96%, 74% 98%, 66% 96%, 58% 98%, 50% 96%, 42% 98%, 34% 96%, 26% 98%, 18% 96%, 10% 98%, 6% 96%, 3% 94%,
    2% 88%, 3% 82%, 1% 76%, 3% 68%, 1% 60%, 3% 52%, 1% 44%, 3% 36%, 1% 28%, 3% 20%, 2% 14%
  );

  /* –ö–õ–Æ–ß: –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –Ω–µ —Å–∂–∏–º–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã, –∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –≤–µ—Å—å –ª–∏—Å—Ç */
  transform: scale(var(--uiScale));
  transform-origin: top center;
}
.sheet::before{
  content:"";
  position:absolute;
  inset:-16px;
  pointer-events:none;
  background:
    radial-gradient(115% 85% at 50% 45%, rgba(255,255,255,.16), rgba(255,255,255,0) 58%),
    radial-gradient(145% 120% at 50% 50%, rgba(0,0,0,.28), rgba(0,0,0,0) 64%),
    radial-gradient(130% 115% at 50% 50%, rgba(182,58,46,.20), rgba(182,58,46,0) 70%),
    radial-gradient(130% 115% at 50% 50%, rgba(229,154,58,.18), rgba(229,154,58,0) 74%);
  box-shadow:
    0 0 0 2px rgba(59,42,26,.58),
    0 0 0 8px rgba(59,42,26,.12);
  mix-blend-mode:multiply;
  opacity:.92;
  clip-path: inherit;
}
.sheet::after{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  background:
    radial-gradient(18px 18px at 10% 10%, rgba(0,0,0,.11), transparent 70%),
    radial-gradient(22px 22px at 90% 12%, rgba(0,0,0,.11), transparent 70%),
    radial-gradient(22px 22px at 92% 90%, rgba(0,0,0,.11), transparent 70%),
    radial-gradient(20px 20px at 12% 92%, rgba(0,0,0,.11), transparent 70%),
    radial-gradient(300px 120px at 50% -10%, rgba(0,0,0,.13), transparent 60%),
    radial-gradient(320px 140px at 50% 110%, rgba(0,0,0,.13), transparent 60%),
    radial-gradient(120px 320px at -10% 50%, rgba(0,0,0,.11), transparent 65%),
    radial-gradient(120px 320px at 110% 50%, rgba(0,0,0,.11), transparent 65%),
    repeating-radial-gradient(circle at 22% 28%, rgba(0,0,0,.03) 0 1px, rgba(0,0,0,0) 1px 4px),
    repeating-radial-gradient(circle at 75% 68%, rgba(0,0,0,.025) 0 1px, rgba(0,0,0,0) 1px 5px);
  mix-blend-mode:multiply;
  opacity:.78;
  clip-path: inherit;
}

.title{
  text-align:center;
  font-size:54px;
  margin:0 0 22px;
  letter-spacing:.5px;
  text-shadow: 0 2px 0 rgba(255,255,255,.5);
}

.map{
  position:relative;
  height:520px;
  border: 3px solid rgba(59,42,26,.75);
  border-radius:14px;
  background:
    radial-gradient(900px 520px at 60% 40%, rgba(255,255,255,.28), transparent 60%),
    radial-gradient(200px 120px at 25% 70%, rgba(0,0,0,.05), transparent 70%),
    linear-gradient(135deg, #f8efd8, #f3e3bf);
  overflow:hidden;
  box-shadow: inset 0 0 22px rgba(0,0,0,.12);
}
.map:before{
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(60px 40px at 20% 25%, rgba(0,0,0,.06), transparent 70%),
    radial-gradient(90px 60px at 60% 55%, rgba(0,0,0,.05), transparent 70%),
    radial-gradient(70px 50px at 85% 70%, rgba(0,0,0,.05), transparent 70%);
  pointer-events:none;
  opacity:.75;
}

/* ===== –ö–æ–º–Ω–∞—Ç—ã ===== */
.rooms{ position:absolute; inset:14px; z-index:1; pointer-events:none; }
.room{
  position:absolute;
  border: 2px solid rgba(42,28,18,.55);
  border-radius:18px;
  background: linear-gradient(180deg, rgba(229,154,58,.06), rgba(182,58,46,.03));
  box-shadow: inset 0 0 0 2px rgba(255,255,255,.35);
  filter: drop-shadow(0 2px 0 rgba(0,0,0,.08));
}

/* ===== –î–≤–µ—Ä–∏ ===== */
.door{
  position:absolute;
  background: var(--floor);
  border-radius:8px;
  z-index:3;
  box-shadow:
    inset 0 0 0 1px rgba(42,28,18,.18),
    0 1px 0 rgba(255,255,255,.35);
}
.door::before,.door::after{
  content:"";
  position:absolute;
  background: rgba(42,28,18,.55);
  border-radius:2px;
  opacity:.8;
}
.door.v{ width:16px; height:44px; }
.door.v::before{ left:2px; top:4px; width:2px; height:36px; }
.door.v::after { right:2px; top:4px; width:2px; height:36px; }
.door.h{ width:44px; height:16px; }
.door.h::before{ top:2px; left:4px; width:36px; height:2px; }
.door.h::after { bottom:2px; left:4px; width:36px; height:2px; }

.room-bedroom{ top:0; left:0; width:45%; height:50%; }
.room-kitchen{ bottom:0; left:0; width:35%; height:50%; }
.room-toilet{ bottom:0; left:35%; width:10%; height:25%; }
.room-bath{ top:0; left:45%; width:10%; height:30%; border-radius:14px; }
.room-hall{ bottom:0; left:45%; width:10%; height:70%; border-radius:14px; }
.room-living{ top:0; right:0; width:45%; height:66%; }

/* ===== –ù–∞–∑–≤–∞–Ω–∏—è ===== */
.room-label{
  position:absolute;
  font-size:24px;
  color: rgba(42,28,18,.82);
  z-index:3;
  text-shadow: 0 1px 0 rgba(255,255,255,.65);
  font-style: italic;
  letter-spacing:.4px;
}

/* ===== –ö–æ–º–ø–∞—Å ===== */
.compass{
  position:absolute;
  right:16px;
  bottom:16px;
  width:110px;
  height:110px;
  opacity:.85;
  z-index:2;
  filter: drop-shadow(0 3px 0 rgba(0,0,0,.15));
}
.compass svg{ width:100%; height:100%; }

/* ===== –ú–∞—Ä—à—Ä—É—Ç (—Ç–æ—á–µ—á–Ω—ã–π –ø—É–Ω–∫—Ç–∏—Ä) ===== */
.route{ position:absolute; inset:0; z-index:2; pointer-events:none; opacity:.95; }
.route path{
  stroke: rgba(42,28,18,.78);
  stroke-width: 4.6;
  fill:none;
  stroke-linecap: round;
  stroke-linejoin: round;
  stroke-dasharray: 1 14;
  stroke-dashoffset: 0;
}

/* ===== –ö–∞–º–Ω–∏ (–ø–æ—è–≤–ª—è—é—Ç—Å—è –∏–∑ —Å—É–Ω–¥—É–∫–æ–≤) ===== */
.gem{
  position:absolute;
  width:34px;
  height:34px;
  transform: rotate(45deg) scale(.75);
  border: 3px solid var(--ink);
  border-radius: 7px;
  box-shadow:
    inset 0 0 8px rgba(255,255,255,.55),
    0 6px 14px rgba(0,0,0,.20);
  z-index:5;
  opacity:0;
  pointer-events:none;
  transition: opacity .22s ease, transform .22s ease;
}
.gem.show{
  opacity:1;
  transform: rotate(45deg) scale(1);
  pointer-events:auto;
}
.gray   { background: linear-gradient(135deg, #bdbdbd, #8e8e8e); }
.white  { background: linear-gradient(135deg, #ffffff, #e8e8e8); }
.orange { background: linear-gradient(135deg, #f2b35c, #d4842a); }
.red    { background: linear-gradient(135deg, #d65a4a, #9f2c24); }
.gem::after{
  content:"";
  position:absolute; inset:-10px;
  background: radial-gradient(circle, rgba(255,255,255,.35), transparent 60%);
  transform: rotate(-45deg);
  opacity:.5;
}

/* ===== –°—É–Ω–¥—É–∫–∏ ===== */
.chest{
  position:absolute;
  width:46px;
  height:36px;
  z-index:4;
  border: 3px solid var(--ink);
  border-radius: 8px;
  background:
    linear-gradient(180deg, rgba(255,255,255,.20), rgba(0,0,0,.06)),
    linear-gradient(135deg, #c28a3a, #8f5b1e);
  box-shadow: 0 10px 18px rgba(0,0,0,.18), inset 0 0 10px rgba(255,255,255,.20);
  transform: scale(.85);
  opacity: 0;
  pointer-events: none;
  transition: opacity .25s ease, transform .25s ease;
}
.chest.show{
  opacity: 1;
  transform: scale(1);
  pointer-events: auto;
  cursor: pointer;
}
.chest::before{
  content:"";
  position:absolute;
  left:-3px; right:-3px;
  top:-3px;
  height:40%;
  border: 3px solid var(--ink);
  border-bottom: 0;
  border-radius: 10px 10px 8px 8px;
  background:
    linear-gradient(180deg, rgba(255,255,255,.18), rgba(0,0,0,.08)),
    linear-gradient(135deg, #d6a04a, #9a6522);
  transform-origin: 50% 100%;
  transition: transform .22s ease;
}
.chest::after{
  content:"";
  position:absolute;
  width:10px;
  height:12px;
  left:50%;
  top:50%;
  transform: translate(-50%,-35%);
  border: 2px solid rgba(42,28,18,.85);
  border-radius: 3px;
  background: linear-gradient(180deg, #f2d37a, #c79a38);
  box-shadow: inset 0 0 6px rgba(255,255,255,.25);
}
.chest.opened::before{
  transform: rotateX(55deg) translateY(-2px);
}

/* ===== –í–æ–ø—Ä–æ—Å ===== */
.question{
  position:absolute;
  width:34px;
  height:34px;
  border-radius: 50%;
  border: 3px solid var(--ink);
  background: linear-gradient(180deg, #fff7e0, #f4e7c4);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  font-weight:bold;
  color: var(--ink);
  box-shadow: 0 6px 14px rgba(0,0,0,.18), inset 0 0 8px rgba(255,255,255,.65);
  z-index:4;
}

/* ===== –ü–æ–∑–∏—Ü–∏–∏ ===== */
#p1, #c1 { top: 360px; left: 420px; }
#p2, #c2 { top: 460px; left: 70px; }
#p3, #c3 { top: 20px; left: 400px; }
#p4, #c4 { top: 40px; left: 630px; }
#p5 { top: 140px; left: 180px; }

/* –ø–æ–¥—Å–∫–∞–∑–∫–∞ */
.clue{
  margin-top: 22px;
  font-size: 28px;
  border-top: 2px solid rgba(42,28,18,.75);
  padding-top: 18px;
  color: var(--ink);
}

button{
  margin-top: 18px;
  padding: 12px 20px;
  font-family: inherit;
  font-size: 24px;
  background: rgba(255,255,255,.25);
  border: 2px solid rgba(42,28,18,.85);
  border-radius: 14px;
  cursor:pointer;
  box-shadow: 0 8px 16px rgba(0,0,0,.15);
  transition: transform .08s ease, box-shadow .12s ease;
}
button:hover{ transform: translateY(-1px); box-shadow: 0 10px 18px rgba(0,0,0,.18); }
button:active{ transform: translateY(0px); box-shadow: 0 6px 12px rgba(0,0,0,.16); }

/* ===== –ü–∞–ø–∏—Ä—É—Å ===== */
.papyrus-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 18px;
}
.papyrus-overlay.show{ display:flex; }
.papyrus{
  position: relative;
  width: min(520px, 92vw);
  padding: 30px 34px;
  background: linear-gradient(135deg, var(--paper), var(--paper2));
  border: 2px solid rgba(59,42,26,.7);
  border-radius: 18px;
  box-shadow: 0 22px 60px rgba(0,0,0,.35), inset 0 0 70px rgba(0,0,0,.12);
  text-align: center;
  color: var(--ink);
  transform: translateY(12px) scale(.98);
  opacity: 0;
  transition: transform .22s ease, opacity .22s ease;
}
.papyrus-overlay.show .papyrus{
  transform: translateY(0) scale(1);
  opacity: 1;
}
.papyrus::before,
.papyrus::after{
  content:"";
  position:absolute;
  top: 50%;
  width: 38px;
  height: 76%;
  transform: translateY(-50%);
  background: linear-gradient(180deg, rgba(255,255,255,.25), rgba(0,0,0,.08));
  border: 2px solid rgba(59,42,26,.55);
  border-radius: 20px;
  box-shadow: inset 0 0 18px rgba(0,0,0,.12);
}
.papyrus::before{ left: -20px; }
.papyrus::after { right: -20px; }
.papyrus-title{ font-size: 42px; margin: 0 0 6px; text-shadow: 0 2px 0 rgba(255,255,255,.55); }
.papyrus-text{ font-size: 40px; margin: 10px 0 14px; }
.papyrus-hint{ font-size: 20px; opacity: .8; margin: 0; }
</style>
</head>

<body>
  <div class="sheet">
    <div class="title">–ö–∞—Ä—Ç–∞ —Å–æ–∫—Ä–æ–≤–∏—â</div>

    <div class="map" id="map">
      <div class="rooms">
        <div class="room room-bedroom" id="room-bedroom">
          <span class="door v" id="door-bedroom" style="right:-8px; bottom:18px;"></span>
        </div>

        <div class="room room-kitchen">
          <span class="door v" id="door-kitchen" style="right:-8px; top:18px;"></span>
        </div>

        <div class="room room-bath" id="room-bath">
          <span class="door h" id="door-bath" style="left:50%; bottom:-8px; transform:translateX(-50%);"></span>
        </div>

        <div class="room room-hall" id="room-hall"></div>

        <div class="room room-living" id="room-living">
          <span class="door v" id="door-living" style="left:-8px; top:56%; transform:translateY(-50%);"></span>
        </div>

        <div class="room room-toilet" id="room-toilet">
          <span class="door h" id="door-throne" style="left:50%; top:-8px; transform:translateX(-50%);"></span>
        </div>
      </div>

      <div class="room-label" style="top:120px; left:95px; transform:rotate(-2deg); font-size:25px">–¢–∞–π–Ω–∞ –°–Ω–æ–≤</div>
      <div class="room-label" style="bottom:120px; left:50px; transform:rotate(1.5deg); font-size:25px">–ë—É—Ö—Ç–∞ –ü—Ä—è–Ω–æ—Å—Ç–µ–π</div>
      <div class="room-label" style="top:85px; left:330px; font-size:25px; transform:rotate(-1deg);">–û–∑–µ—Ä–æ –¢—É–º–∞–Ω–æ–≤</div>
      <div class="room-label" style="bottom:30px; left:320px; transform:rotate(1deg); font-size:25px">–í—Ä–∞—Ç–∞ –ö–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–∞</div>
      <div class="room-label" style="top:170px; right:130px; transform:rotate(-1.2deg);">–ó–∞–ª –û–±—ä—è—Ç–∏–π</div>
      <div class="room-label" style="bottom:80px; left:260px; transform:rotate(-1.2deg);">–¢—Ä–æ–Ω–Ω—ã–π –∑–∞–ª</div>

      <svg class="route" id="routeSvg" viewBox="0 0 900 520" preserveAspectRatio="none">
        <path id="routePath" d="M 0 0 L 0 0"></path>
      </svg>

      <div class="compass" aria-hidden="true">
        <svg viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="46" stroke="rgba(42,28,18,.65)" stroke-width="2.5" fill="rgba(255,255,255,.18)"/>
          <circle cx="50" cy="50" r="34" stroke="rgba(42,28,18,.35)" stroke-width="2" fill="transparent"/>
          <path d="M50 12 L58 50 L50 88 L42 50 Z" fill="rgba(182,58,46,.75)" stroke="rgba(42,28,18,.55)" stroke-width="2"/>
          <path d="M12 50 L50 42 L88 50 L50 58 Z" fill="rgba(229,154,58,.35)" stroke="rgba(42,28,18,.35)" stroke-width="2"/>
          <text x="50" y="20" text-anchor="middle" font-size="12" fill="rgba(42,28,18,.85)">N</text>
          <text x="50" y="94" text-anchor="middle" font-size="12" fill="rgba(42,28,18,.85)">S</text>
          <text x="8" y="54" text-anchor="middle" font-size="12" fill="rgba(42,28,18,.85)">W</text>
          <text x="92" y="54" text-anchor="middle" font-size="12" fill="rgba(42,28,18,.85)">E</text>
        </svg>
      </div>

      <!-- —Å—É–Ω–¥—É–∫–∏ -->
      <div class="chest" id="c1" title="–°—É–Ω–¥—É–∫ 1"></div>
      <div class="chest" id="c2" title="–°—É–Ω–¥—É–∫ 2"></div>
      <div class="chest" id="c3" title="–°—É–Ω–¥—É–∫ 3"></div>
      <div class="chest" id="c4" title="–°—É–Ω–¥—É–∫ 4"></div>

      <!-- –∫–∞–º–Ω–∏ -->
      <div class="gem gray" id="p1" title="–°–µ—Ä—ã–π –∫–∞–º–µ–Ω—å"></div>
      <div class="gem white" id="p2" title="–ë–µ–ª—ã–π –∫–∞–º–µ–Ω—å"></div>
      <div class="gem orange" id="p3" title="–û—Ä–∞–Ω–∂–µ–≤—ã–π –∫–∞–º–µ–Ω—å"></div>
      <div class="gem red" id="p4" title="–ö—Ä–∞—Å–Ω—ã–π –∫–∞–º–µ–Ω—å"></div>

      <div class="question" id="p5" title="–¢–∞–π–Ω–∞ –°–Ω–æ–≤">?</div>
    </div>

    <div class="clue" id="clue">–ù–∞–∂–º–∏ ¬´–°–ª–µ–¥—É—é—â–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ—Ö–æ—Ç—É.</div>
    <button id="nextBtn" type="button" onclick="next()">–°–ª–µ–¥—É—é—â–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞</button>
  </div>

  <!-- –ø–∞–ø–∏—Ä—É—Å -->
  <div class="papyrus-overlay" id="papyrusOverlay" role="dialog" aria-modal="true" aria-label="–ü–∞–ø–∏—Ä—É—Å">
    <div class="papyrus" id="papyrusBox">
      <div class="papyrus-text">–≠—Ç–æ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å, –Ω–æ –≤—Å—ë –µ—â—ë —Ç–æ–ª—å–∫–æ –≤–ø–µ—Ä–µ–¥–∏.</div>
      <p class="papyrus-hint">–õ—é–±–ª—é —Ç–µ–±—è, –º–∏–ª–∞—è, —Å –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–º üíñ</p>
    </div>
  </div>

<script>
/* ‚úÖ –Ω–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ (–≤ —Å—Ç–∏–ª–µ —Å–æ–∫—Ä–æ–≤–∏—â) */
const clues = [
  "–°–ª—É—à–∞–π –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ, –∏—Å–∫–∞—Ç–µ–ª—å! –ü–µ—Ä–≤—ã–π —Å—É–Ω–¥—É–∫ –ø—Ä—è—á–µ—Ç—Å—è —Ç–∞–º, –≥–¥–µ –¥–æ–º —Ö—Ä–∞–Ω–∏—Ç –±–µ–ª—ã–µ –ø–∞—Ä—É—Å–∞ —á–∏—Å—Ç–æ—Ç—ã. –ó–∞–≥–ª—è–Ω–∏ –≤ —à–∫–∞—Ñ —Å –±–µ–ª—å—ë–º ‚Äî —Å–µ—Ä—ã–π —Ñ–µ–æ–Ω–∏—Ç –∂–¥—ë—Ç, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø—É—Ç—å.",
  "–°–ª–µ–¥—É—é—â–∞—è –¥–æ–±—ã—á–∞ —Å—Ä–µ–¥–∏ –≤–∫—É—Å–Ω—ã—Ö —Ç—Ä–æ—Ñ–µ–µ–≤. –û—Ç–∫—Ä–æ–π –∫—É—Ö–æ–Ω–Ω—ã–π —à–∫–∞—Ñ —Å–æ —Å–Ω–µ–∫–∞–º–∏ ‚Äî —Ç–∞–º —Å—É–Ω–¥—É–∫, –∞ –≤ –Ω—ë–º –±–µ–ª—ã–π –±—Ä–∏–ª–ª–∏–∞–Ω—Ç, –∫–∞–∫ –∏—Å–∫—Ä–∞ –Ω–∞ –ª–∞–¥–æ–Ω–∏.",
  "–¢—Ä–µ—Ç–∏–π —Å–ª–µ–¥ –≤–µ–¥—ë—Ç –∫ –∞—Ä–æ–º–∞—Ç–∞–º –∏ –ø–µ–Ω–µ. –í —à–∫–∞—Ñ—É —Å –∫—Ä–µ–º–∞–º–∏ –∏ –º—ã–ª—å–Ω–æ-—Ä—ã–ª—å–Ω—ã–º–∏ –±–æ–≥–∞—Ç—Å—Ç–≤–∞–º–∏ —Å–ø—Ä—è—Ç–∞–Ω —Å—É–Ω–¥—É–∫ ‚Äî –¥–æ—Å—Ç–∞–Ω—å –æ—Ä–∞–Ω–∂–µ–≤—ã–π —Ç–æ–ø–∞–∑, –∫–∞–∫ –º–∞–ª–µ–Ω—å–∫–æ–µ —Å–æ–ª–Ω—Ü–µ.",
  "–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–ª–∞–¥ –±–ª–∏–∂–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è. –ò—â–∏ –Ω–∞ –¥–∏–≤–∞–Ω–µ: –ø–æ–¥ –ø–æ–¥—É—à–∫–æ–π —Å–ø—Ä—è—Ç–∞–Ω —Å—É–Ω–¥—É–∫, –∞ –≤ –Ω—ë–º –∫—Ä–∞—Å–Ω—ã–π —Ä—É–±–∏–Ω ‚Äî —Å–µ—Ä–¥—Ü–µ —ç—Ç–æ–≥–æ –¥–æ–º–∞.",
  "–≠—Ç–æ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å, –Ω–æ –≤—Å—ë –µ—â—ë —Ç–æ–ª—å–∫–æ –≤–ø–µ—Ä–µ–¥–∏."
];

let i = -1;              // —Å—Ç–∞—Ä—Ç: –ø–æ–¥—Å–∫–∞–∑–æ–∫ –µ—â—ë –Ω–µ –±—ã–ª–æ
let finalReady = false;
let started = false;

const stepLoot = [
  { chestId: "c1", gemId: "p1" },
  { chestId: "c2", gemId: "p2" },
  { chestId: "c3", gemId: "p3" },
  { chestId: "c4", gemId: "p4" },
];

const chestTimers = new Map();

/* ===== –°—É–Ω–¥—É–∫–∏/–∫–∞–º–Ω–∏ ===== */
function showChest(step){
  const cfg = stepLoot[step];
  if(!cfg) return;
  const chest = document.getElementById(cfg.chestId);
  if(!chest) return;
  chest.classList.add("show");
}
function revealGemFromChest(step){
  const cfg = stepLoot[step];
  if(!cfg) return;

  const chest = document.getElementById(cfg.chestId);
  const gem = document.getElementById(cfg.gemId);
  if(!chest || !gem) return;

  chest.classList.add("opened");
  gem.classList.add("show");
}
function scheduleChest(step){
  if(step < 0 || step > 3) return;

  // –µ—Å–ª–∏ —É–∂–µ –ø–æ—è–≤–ª—è–ª—Å—è ‚Äî –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º
  const chest = document.getElementById(stepLoot[step].chestId);
  if(chest && chest.classList.contains("show")) return;

  // –µ—Å–ª–∏ —É–∂–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ ‚Äî –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º
  if(chestTimers.has(step)) return;

  const t = setTimeout(() => {
    showChest(step);
    chestTimers.delete(step);
    // —á—É—Ç—å –æ–±–Ω–æ–≤–∏–º –ø–æ–¥—Å–≤–µ—Ç–∫—É (–µ—Å–ª–∏ —Å–µ–π—á–∞—Å —ç—Ç–æ—Ç —à–∞–≥)
    if(i === step) highlight(step);
  }, 7000);

  chestTimers.set(step, t);
}
function bindChestClicks(){
  stepLoot.forEach((cfg, step) => {
    const chest = document.getElementById(cfg.chestId);
    if(!chest) return;
    chest.addEventListener("click", () => {
      if(!chest.classList.contains("show")) return;
      revealGemFromChest(step);
    });
  });
}

/* ===== –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–π —Ü–µ–ª–∏ ===== */
function highlight(step){
  // –æ—á–∏—Å—Ç–∫–∞
  stepLoot.forEach(cfg => {
    const chest = document.getElementById(cfg.chestId);
    const gem = document.getElementById(cfg.gemId);
    if(chest){ chest.style.outline="none"; chest.style.outlineOffset="2px"; }
    if(gem){ gem.style.outline="none"; gem.style.outlineOffset="2px"; }
  });
  const q = document.getElementById("p5");
  if(q){ q.style.outline="none"; q.style.outlineOffset="2px"; }

  if(step >= 0 && step <= 3){
    const cfg = stepLoot[step];
    const chest = document.getElementById(cfg.chestId);
    const gem = document.getElementById(cfg.gemId);
    const target = (chest && chest.classList.contains("show")) ? chest : gem;
    if(target){
      target.style.outline = "4px solid rgba(229,154,58,.55)";
      target.style.outlineOffset = "2px";
    }
    return;
  }
  if(step === 4 && q){
    q.style.outline = "4px solid rgba(229,154,58,.55)";
    q.style.outlineOffset = "2px";
  }
}

/* ===== map(px) -> svg(viewBox) ===== */
const VBW = 900;
const VBH = 520;

function centerInMapPx(el){
  const map = document.getElementById("map");
  const r = el.getBoundingClientRect();
  const m = map.getBoundingClientRect();
  return { x: (r.left - m.left) + r.width/2, y: (r.top - m.top) + r.height/2, w:r.width, h:r.height };
}
function rectInMapPx(el){
  const map = document.getElementById("map");
  const r = el.getBoundingClientRect();
  const m = map.getBoundingClientRect();
  return { left: r.left - m.left, top: r.top - m.top, width: r.width, height: r.height };
}
function mapPxToSvg(ptPx){
  const map = document.getElementById("map");
  const mr = map.getBoundingClientRect();
  return {
    x: ptPx.x * (VBW / mr.width),
    y: ptPx.y * (VBH / mr.height),
    w: (ptPx.w ?? 0) * (VBW / mr.width),
    h: (ptPx.h ?? 0) * (VBH / mr.width)
  };
}
function mapPxToSvgXY(x, y){
  const map = document.getElementById("map");
  const mr = map.getBoundingClientRect();
  return { x: x * (VBW / mr.width), y: y * (VBH / mr.height) };
}
function centerOfElInSvg(el){
  const map = document.getElementById("map");
  const r = el.getBoundingClientRect();
  const m = map.getBoundingClientRect();
  const x = (r.left - m.left) + r.width/2;
  const y = (r.top  - m.top ) + r.height/2;
  return mapPxToSvg({ x, y, w:r.width, h:r.height });
}
function norm(vx, vy){
  const l = Math.hypot(vx, vy) || 1;
  return { x: vx/l, y: vy/l };
}

/* ===== –ú–∞—Ä—à—Ä—É—Ç—ã ===== */
function buildRouteStep0(){
  const start = document.getElementById("p5");
  const door  = document.getElementById("door-bedroom");
  const hall  = document.getElementById("room-hall");
  const stone = document.getElementById("p1");
  const path  = document.getElementById("routePath");
  if(!start || !door || !hall || !stone || !path) return;

  const A = mapPxToSvg(centerInMapPx(start));
  const D = centerOfElInSvg(door);
  const H = mapPxToSvg(centerInMapPx(hall));
  const S = mapPxToSvg(centerInMapPx(stone));

  const corridorX = H.x;

  const dirAD = norm(D.x - A.x, D.y - A.y);
  const beforeDoor = { x: D.x - dirAD.x * 18, y: D.y - dirAD.y * 18 };
  const afterDoor  = { x: D.x + dirAD.x * 22, y: D.y + dirAD.y * 22 };

  const Pturn = { x: corridorX, y: afterDoor.y + 78 };
  const downEnd = { x: corridorX, y: S.y - 28 };

  const approach = norm(S.x - downEnd.x, S.y - downEnd.y);
  const B = { x: S.x + approach.x * 12, y: S.y + approach.y * 12 };

  const c1 = { x: A.x + 86, y: A.y + 2 };
  const c2 = { x: beforeDoor.x - 18, y: beforeDoor.y - 12 };

  const c3 = { x: afterDoor.x + 18, y: afterDoor.y + 14 };
  const c4 = { x: corridorX,        y: afterDoor.y + 46 };

  const c5 = { x: corridorX, y: (Pturn.y + downEnd.y) / 2 };

  const c6 = { x: corridorX + 6, y: downEnd.y + 18 };
  const c7 = { x: S.x - 6,       y: S.y + 2 };

  path.setAttribute("d",
    `M ${A.x.toFixed(1)} ${A.y.toFixed(1)}
     C ${c1.x.toFixed(1)} ${c1.y.toFixed(1)}, ${c2.x.toFixed(1)} ${c2.y.toFixed(1)}, ${beforeDoor.x.toFixed(1)} ${beforeDoor.y.toFixed(1)}
     L ${D.x.toFixed(1)} ${D.y.toFixed(1)}
     L ${afterDoor.x.toFixed(1)} ${afterDoor.y.toFixed(1)}
     C ${c3.x.toFixed(1)} ${c3.y.toFixed(1)}, ${c4.x.toFixed(1)} ${c4.y.toFixed(1)}, ${Pturn.x.toFixed(1)} ${Pturn.y.toFixed(1)}
     S ${c5.x.toFixed(1)} ${c5.y.toFixed(1)}, ${downEnd.x.toFixed(1)} ${downEnd.y.toFixed(1)}
     C ${c6.x.toFixed(1)} ${c6.y.toFixed(1)}, ${c7.x.toFixed(1)} ${c7.y.toFixed(1)}, ${B.x.toFixed(1)} ${B.y.toFixed(1)}`
  );
}
function buildRouteStep1(){
  const from  = document.getElementById("p1");
  const door  = document.getElementById("door-kitchen");
  const to    = document.getElementById("p2");
  const path  = document.getElementById("routePath");
  if(!from || !door || !to || !path) return;

  const A = mapPxToSvg(centerInMapPx(from));
  const D = centerOfElInSvg(door);
  const B = mapPxToSvg(centerInMapPx(to));

  const dirAD = norm(D.x - A.x, D.y - A.y);
  const beforeDoor = { x: D.x - dirAD.x * 14, y: D.y - dirAD.y * 14 };

  const dirDB = norm(B.x - D.x, B.y - D.y);
  const afterDoor  = { x: D.x + dirDB.x * 16, y: D.y + dirDB.y * 16 };

  const c1 = { x: A.x - 70, y: A.y + 25 };
  const c2 = { x: beforeDoor.x - 22, y: beforeDoor.y + 10 };

  const c3 = { x: afterDoor.x - 10, y: afterDoor.y + 35 };
  const c4 = { x: B.x + 55, y: B.y - 10 };

  path.setAttribute("d",
    `M ${A.x.toFixed(1)} ${A.y.toFixed(1)}
     C ${c1.x.toFixed(1)} ${c1.y.toFixed(1)}, ${c2.x.toFixed(1)} ${c2.y.toFixed(1)}, ${beforeDoor.x.toFixed(1)} ${beforeDoor.y.toFixed(1)}
     L ${D.x.toFixed(1)} ${D.y.toFixed(1)}
     L ${afterDoor.x.toFixed(1)} ${afterDoor.y.toFixed(1)}
     C ${c3.x.toFixed(1)} ${c3.y.toFixed(1)}, ${c4.x.toFixed(1)} ${c4.y.toFixed(1)}, ${B.x.toFixed(1)} ${B.y.toFixed(1)}`
  );
}
function buildRouteStep2(){
  const from   = document.getElementById("p2");
  const doorK  = document.getElementById("door-kitchen");
  const hall   = document.getElementById("room-hall");
  const bed    = document.getElementById("room-bedroom");
  const doorW  = document.getElementById("door-bath");
  const to     = document.getElementById("p3");
  const path   = document.getElementById("routePath");
  if(!from || !doorK || !hall || !bed || !doorW || !to || !path) return;

  const A  = mapPxToSvg(centerInMapPx(from));
  const K  = centerOfElInSvg(doorK);
  const H  = mapPxToSvg(centerInMapPx(hall));
  const D  = centerOfElInSvg(doorW);
  const B  = mapPxToSvg(centerInMapPx(to));

  const bedRectPx = rectInMapPx(bed);
  const bedBottomSvg = mapPxToSvgXY(
    bedRectPx.left + bedRectPx.width * 0.5,
    bedRectPx.top  + bedRectPx.height
  );

  const corridorX = H.x;
  const marginLow = 26;

  const P0 = { x: corridorX, y: K.y };
  const P1 = { x: corridorX, y: bedBottomSvg.y + marginLow };
  const P2 = { x: corridorX, y: D.y + 34 };

  const dirAK = norm(K.x - A.x, K.y - A.y);
  const beforeK = { x: K.x - dirAK.x * 14, y: K.y - dirAK.y * 14 };
  const afterK  = { x: K.x + (corridorX - K.x) * 0.40, y: K.y + 10 };

  const dirToStone = norm(B.x - D.x, B.y - D.y);
  const afterD = { x: D.x + dirToStone.x * 18, y: D.y + dirToStone.y * 18 };

  const c1 = { x: A.x + 60, y: A.y - 60 };
  const c2 = { x: beforeK.x - 30, y: beforeK.y - 20 };

  path.setAttribute("d",
    `M ${A.x.toFixed(1)} ${A.y.toFixed(1)}
     C ${c1.x.toFixed(1)} ${c1.y.toFixed(1)}, ${c2.x.toFixed(1)} ${c2.y.toFixed(1)}, ${beforeK.x.toFixed(1)} ${beforeK.y.toFixed(1)}
     L ${K.x.toFixed(1)} ${K.y.toFixed(1)}
     L ${afterK.x.toFixed(1)} ${afterK.y.toFixed(1)}
     L ${P0.x.toFixed(1)} ${P0.y.toFixed(1)}
     L ${P1.x.toFixed(1)} ${P1.y.toFixed(1)}
     L ${P2.x.toFixed(1)} ${P2.y.toFixed(1)}
     L ${D.x.toFixed(1)} ${D.y.toFixed(1)}
     L ${afterD.x.toFixed(1)} ${afterD.y.toFixed(1)}
     L ${B.x.toFixed(1)} ${B.y.toFixed(1)}`
  );
}
function buildRouteStep3(){
  const from    = document.getElementById("p3");
  const doorBath= document.getElementById("door-bath");
  const hall    = document.getElementById("room-hall");
  const doorLiv = document.getElementById("door-living");
  const to      = document.getElementById("p4");
  const path    = document.getElementById("routePath");
  if(!from || !doorBath || !hall || !doorLiv || !to || !path) return;

  const A  = mapPxToSvg(centerInMapPx(from));
  const Db = centerOfElInSvg(doorBath);
  const H  = mapPxToSvg(centerInMapPx(hall));
  const Dl = centerOfElInSvg(doorLiv);
  const B  = mapPxToSvg(centerInMapPx(to));

  const corridorX = H.x;

  const dirAD = norm(Db.x - A.x, Db.y - A.y);
  const beforeBath = { x: Db.x - dirAD.x * 16, y: Db.y - dirAD.y * 16 };
  const afterBath  = { x: Db.x + (corridorX - Db.x) * 0.55, y: Db.y + 18 };

  const P0 = { x: corridorX, y: afterBath.y };
  const P1 = { x: corridorX, y: Dl.y };

  const beforeLiving = { x: Dl.x - 18, y: Dl.y };
  const afterLiving  = { x: Dl.x + 22, y: Dl.y };

  const c1 = { x: afterLiving.x + 80, y: afterLiving.y - 55 };
  const c2 = { x: B.x - 70,          y: B.y + 10 };

  path.setAttribute("d",
    `M ${A.x.toFixed(1)} ${A.y.toFixed(1)}
     L ${beforeBath.x.toFixed(1)} ${beforeBath.y.toFixed(1)}
     L ${Db.x.toFixed(1)} ${Db.y.toFixed(1)}
     L ${afterBath.x.toFixed(1)} ${afterBath.y.toFixed(1)}
     L ${P0.x.toFixed(1)} ${P0.y.toFixed(1)}
     L ${P1.x.toFixed(1)} ${P1.y.toFixed(1)}
     L ${beforeLiving.x.toFixed(1)} ${beforeLiving.y.toFixed(1)}
     L ${Dl.x.toFixed(1)} ${Dl.y.toFixed(1)}
     L ${afterLiving.x.toFixed(1)} ${afterLiving.y.toFixed(1)}
     C ${c1.x.toFixed(1)} ${c1.y.toFixed(1)}, ${c2.x.toFixed(1)} ${c2.y.toFixed(1)}, ${B.x.toFixed(1)} ${B.y.toFixed(1)}`
  );
}

/* ===== –ê–Ω–∏–º–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ ===== */
function animateCurrentRoute(buildFn, onDone){
  const path = document.getElementById("routePath");
  if(!path) return;

  buildFn();
  const len = path.getTotalLength();

  const speed = 0.22; // px/ms
  const durationMs = Math.max(2400, Math.min(8200, len / speed));

  path.style.transition = "none";
  path.style.strokeDashoffset = String(len);

  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      path.style.transition = `stroke-dashoffset ${durationMs}ms ease-in-out`;
      path.style.strokeDashoffset = "0";

      if(typeof onDone === "function"){
        window.clearTimeout(animateCurrentRoute._t);
        animateCurrentRoute._t = window.setTimeout(() => onDone(), durationMs + 30);
      }
    });
  });
}
function animateRouteForStep(step, onDone){
  if(step === 0) animateCurrentRoute(buildRouteStep0, onDone);
  if(step === 1) animateCurrentRoute(buildRouteStep1, onDone);
  if(step === 2) animateCurrentRoute(buildRouteStep2, onDone);
  if(step === 3) animateCurrentRoute(buildRouteStep3, onDone);
}

/* ===== –ü–∞–ø–∏—Ä—É—Å ===== */
function showPapyrus(){ document.getElementById("papyrusOverlay")?.classList.add("show"); }
function hidePapyrus(){ document.getElementById("papyrusOverlay")?.classList.remove("show"); }
document.addEventListener("DOMContentLoaded", () => {
  bindChestClicks();
  const overlay = document.getElementById("papyrusOverlay");
  const box = document.getElementById("papyrusBox");
  if(box) box.addEventListener("click", () => hidePapyrus());
  if(overlay) overlay.addEventListener("click", (e) => { if(e.target === overlay) hidePapyrus(); });
});
window.addEventListener("keydown", (e) => { if(e.key === "Escape") hidePapyrus(); });

/* ===== –ö–Ω–æ–ø–∫–∞ ===== */
function makeButtonFinal(){
  const btn = document.getElementById("nextBtn");
  if(!btn) return;
  finalReady = true;
  btn.textContent = "–ù–∞–∂–º–∏";
}

function next(){
  // —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º ‚Äî —Å–≤–∏—Ç–æ–∫
  if(finalReady){
    showPapyrus();
    return;
  }

  // –ø–µ—Ä–≤—ã–π –∫–ª–∏–∫ –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ—Ö–æ—Ç—É (–º–∞—Ä—à—Ä—É—Ç 0 + —Å—É–Ω–¥—É–∫ 0 —á–µ—Ä–µ–∑ 7 —Å–µ–∫)
  if(!started){
    started = true;
    i = 0;
    document.getElementById("clue").textContent = clues[i];
    highlight(0);

    animateRouteForStep(0);
    scheduleChest(0);
    return;
  }

  // –¥–∞–ª—å—à–µ –ø–æ —à–∞–≥–∞–º 1..3
  if(i < 3){
    i++;
    document.getElementById("clue").textContent = clues[i];
    highlight(i);

    animateRouteForStep(i);
    scheduleChest(i);

    if(i === 3){
      // –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–Ω–∏–º–∞—Ü–∏–∏ ‚Äî –∫–Ω–æ–ø–∫–∞ "–ù–∞–∂–º–∏"
      animateRouteForStep(3, () => makeButtonFinal());
    }
    return;
  }

  // —Ç–µ–∫—Å—Ç —Ñ–∏–Ω–∞–ª–∞ (–ø–æ–¥—Å–∫–∞–∑–∫–∞ 5)
  if(i === 3){
    i = 4;
    document.getElementById("clue").textContent = clues[i];
    highlight(4);
    // –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–µ—Ç "–ù–∞–∂–º–∏" —É–∂–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ —à–∞–≥–∞ 3
  }
}

/* resize –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ */
window.addEventListener("resize", () => {
  const path = document.getElementById("routePath");
  if(!path) return;

  path.style.transition = "none";
  if(i === 0) buildRouteStep0();
  if(i === 1) buildRouteStep1();
  if(i === 2) buildRouteStep2();
  if(i === 3) buildRouteStep3();

  // –µ—Å–ª–∏ –µ—â—ë –Ω–µ –Ω–∞—á–∏–Ω–∞–ª–∏ ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç
  if(!started){
    path.style.strokeDashoffset = "0";
    path.setAttribute("d", "M 0 0 L 0 0");
    return;
  }

  path.style.strokeDashoffset = "0";
});

/* ===== –ö–õ–Æ–ß: –∞–≤—Ç–æ-–º–∞—Å—à—Ç–∞–± (–≤–º–µ—Å—Ç–æ "—Å–ø–ª—é—â–∏–≤–∞–Ω–∏—è") ===== */
function applyScale(){
  const sheet = document.querySelector(".sheet");
  if(!sheet) return;

  const available = Math.min(window.innerWidth, document.documentElement.clientWidth) - 24; // –æ—Ç—Å—Ç—É–ø—ã
  const base = 920; // –±–∞–∑–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ –ª–∏—Å—Ç–∞
  const s = Math.min(1, available / base);

  document.documentElement.style.setProperty("--uiScale", s.toFixed(4));
}
window.addEventListener("load", applyScale);
window.addEventListener("resize", applyScale);
</script>
</body>
</html>
